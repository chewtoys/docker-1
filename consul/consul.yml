version: '3.5'
        
services:

  consul_server:
    image: consul:latest
    environment:
      HOSTNAME: consul_server
      CONSUL_UI_BETA: "true"
    command: consul agent -server -config-file /consul/config/config.json
    volumes:
      - consul:/consul/data
      - ./server_config/config.json:/consul/config/config.json:rw
    deploy:
      mode: replicated
      replicas: 1
      endpoint_mode: dnsrr
      update_config:
        parallelism: 1
        failure_action: rollback
        delay: 30s
      restart_policy:
        condition: any
        delay: 5s
        window: 120s
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 1G
    ports:
      - target: 8500
        published: 8500
        mode: host
    # expose:
    #   - "8300"
    #   - "8301"
    #   - "8301/udp"
    #   - "8302"
    #   - "8302/udp"
    networks:
      docker2docker:
        aliases:
          - consul.server


  registrator:
    image: gliderlabs/registrator:latest
    command: -resync 5 -internal -deregister always -cleanup consul://consul_server:8500

    volumes:
      - "/var/run/docker.sock:/tmp/docker.sock"
    depends_on:
      - server
    deploy:
      mode: global
      restart_policy:
        condition: any
        delay: 5s
    networks:
      - docker2docker
    

volumes:
  consul: 
    external: true

networks:
    docker2docker:
        external: true
    host:
        external: true